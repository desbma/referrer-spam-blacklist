#!/bin/bash -eu

# This script requires: diff, git

set -o pipefail

readonly CURRENT_LIST_FILE=/etc/fail2ban/referer-spam-blacklist.txt

# auto cleanup
at_exit() {
  [ "${TMP_DIR:-}" ] && rm -Rf "${TMP_DIR}"
}
trap at_exit EXIT

readonly TMP_DIR=$(mktemp -d /tmp/$(basename -- $0).XXXXXXXXXX)
readonly DIFF_FILE=$TMP_DIR/diff.patch


# rotation
if [ ! -f ${CURRENT_LIST_FILE} ]
then
  : > ${CURRENT_LIST_FILE}
fi

# download blocklist while getting around stupid github hotlink protection
pushd $TMP_DIR > /dev/null
git clone -q  --depth 1 https://github.com/desbma/referer-spam-domains-blacklist.git
popd  > /dev/null
readonly NEW_LIST_FILE=$TMP_DIR/referer-spam-domains-blacklist/spammers.txt

# stats
list_changed=false
diff -U 0 ${CURRENT_LIST_FILE} ${NEW_LIST_FILE} | tail -n +3 > $DIFF_FILE || list_changed=true
echo "$(grep -c '^+' $DIFF_FILE) domains added, $(grep -c '^-' $DIFF_FILE) removed"

if $list_changed
then
  # generate filter file
  echo "# Fail2Ban configuration file
#

# Autogenerated by $(readlink -f $0) @ $(date --rfc-3339 seconds)

[Definition]

failregex = ^<HOST> -.*\"(GET|POST).*HTTP.*\".+\"https?://(.*\.)?($(grep -v '^$' ${NEW_LIST_FILE} | tr '\n' '|' | sed 's/\./\\./g' | sed 's/|$//')).*\" \".*\"$

ignoreregex =
" > /etc/fail2ban/filter.d/apache-referer.local
  mv ${NEW_LIST_FILE} ${CURRENT_LIST_FILE}

  # reload fail2ban
  service fail2ban reload  2>&1 > /dev/null
fi
