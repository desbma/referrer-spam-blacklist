#!/bin/bash -eu

set -o pipefail

readonly F2BCONF="/etc/fail2ban/filter.d/apache-referer.conf"
readonly REPOPATH="/root/referer-spam-domains-blacklist/"
readonly SPAMMERS=$REPOPATH"spammers.txt"

# change to repo path
cd $REPOPATH

# update files from source repo
/usr/bin/git pull

echo "# Fail2Ban configuration file
#

# Autogenerated by $(readlink -f $0) @ $(date --rfc-3339 seconds)

[Definition]

failregex = ^<HOST> -.*\"(GET|POST).*HTTP.*\".+\"https?://(.*\.)?($(grep -v '^$' ${SPAMMERS} | tr '\n' '|' | sed 's/\./\\./g' | sed 's/|$//')).*\" \".*\"$

ignoreregex =

" > $F2BCONF

/usr/sbin/service fail2ban reload
